\setchapterimage{seaside}
\setchapterpreamble[u]{\margintoc}
\chapter{The Forth Programming Language}
\labch{forth}

%
% Key concepts and abilities
%==============================================================================
\begin{kaobox}[frametitle=In This Chapter]
you will learn
\begin{itemize}
	\item First topic
	\item Second topic
        \item Third topic
\end{itemize}

you will be able to
\begin{itemize}
        \item Task one
        \item Task two
        \item Task three
\end{itemize}
\end{kaobox}

% Introductory paragraph goes here
\blindtext

%
% Section: Dictionay Entry Format
%====================================================================
\section{Dictionary Entry Format}

The dictionary entry format is dependent upon the Forth implmentation, but a typical
16-bit Forth system will implement the structure described in \reffig{dictionaryEntryFormat}.

\begin{figure}
\begin{bytefield}[bitwidth=1.25em, endianness=big]{16}
\bitheader{0-15} \\
\begin{rightwordgroup}{name field}
    \bitbox{1}{$p$} & \bitbox{15}{$name$ length ($n$ characters)} \\
    \bitbox{16}{$name[0]$} \\
    \bitbox{16}{$\cdots$} \\
    \bitbox{16}{$name[n]$}
\end{rightwordgroup} \\
    \begin{rightwordgroup}[rightcurly=.]{link address field}
    \wordbox{1}{link address}
\end{rightwordgroup} \\
    \begin{rightwordgroup}[rightcurly=.]{code address field}
    \wordbox{1}{code address}
\end{rightwordgroup} \\
\begin{rightwordgroup}{data field}
    \wordbox{3}{data}
\end{rightwordgroup}
\end{bytefield}

\begin{flushleft}
where, \\
$p$ is the precedence bit,\\
$name$ length is the number of characters in the word name, \\
$char_n$ is the $n^{th}$ character in name,
link address is an address pointing to the first cell of the previous dictionary entry's name field, \\
code address is the address of the machine instruction the interpreter will load for
execution, and \\
data is any data that is required for execution.
\end{flushleft}
\caption[Dictionary entry format]{This is the MacroController Forth dictionary 
    entry format for a 16-bit system. Other Forth systems may implement a differnt format.}
	\labfig{dictionaryEntryFormat}
\end{figure}

\todo[noline]{Decide if the name field characters are 16-bit or 8-bit in the final implementation.}
\marginnote{The code address field is also known as the code pointer field. The data field
is also known as the parameter field.}

Precedence bit. 0 - address of the word gets compiled normally. 1 - The word is executed 
during compilation.

Are the characters in the name field limited to ASCII? Is there any technical reason they
could not be any arbitrary 16-bit value? Maybe null would be a problem.

Leo Brodie's Starting Forth\sidecite{Brodie1981} is good reading for this.

%
% Section: The Forth Inner Interpreter
%====================================================================
\section{The Forth Inner Interpreter}
This section gives a general explaination\sidenote[]{Use sidenotes if necessary} 
of the chapter topic\sidecite{Loeliger1981}.

The word \lstinline|:| causes the innter interpreter to enter compile mode. The name of the
word is next, followed by the definition. The word \lstinline|;| causes the inner
interpreter to exit compilation and reenter interpretation mode.

Example:
\begin{lstlisting}[caption={Definition of \lstinline|dup| in Forth.}]
: square ( x -- x )
    dup
    *
    :
\end{lstlisting}

This, of course, can be more conveniently written on a single line
\begin{lstlisting}[style=kaolstplain,linewidth=1.5\textwidth]
: square ( x -- x )
    dup * ;
\end{lstlisting}

\section{Return Stack}
The top of the return stack holds the return address. When a function call is made, the return address
must be stored.  If the call command is executed at address x, the return address x+1 is pushed to the top of the return stack.

\section{Data Stack}
The data styack is where temporary data is stored.

If a system has only one hardware stack, it shoulld be used for the data stack. Data 
manipulations are more common than function calls and the hardware stack is faster 
than memory access. The call stack will need to be stored in memory.

For "colon words" (words compiled with the : word), the data field is a series of cells, each cell
containing an address pointing to a word in the Forth dictionary.

The address interpreter (inner interpreter) copies the address stored in the address field
into the interpreter pointer then executes the code at that address.

The interpreter does not keep track of or know about the type of word it is working with. The code linked to by the CFA is responsible for behaving appropriately.

%
% Section: The Forth Outter Interpreter
%====================================================================
\section{The Forth Outter Interpreter}
This an intermediate section. There will be several. each such section will cover a
discrete topic within this chapter.

\marginnote{Margin notes can be used to explain detail or add reminders that would
otherwise break the flow of the document. I think sidenotes are numbered while
margin notes are not.}

\blindtext
